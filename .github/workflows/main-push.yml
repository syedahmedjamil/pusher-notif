name: Main - Push

on:
  push:
    branches: [ "main" ]

jobs:
  upload:
    runs-on: macos-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup JDK And Gradle
        uses: ./.github/actions/setup-jdk-gradle
        with:
          cache-read-only: false        
        
      - name: Get Google Services Json
        env:
          CERTIFICATE_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          echo $GOOGLE_SERVICES_JSON | base64 --decode > app/google-services.json

      - name: Get App Release Signing Key
        env:
          CERTIFICATE_BASE64: ${{ secrets.APP_RELEASE_SIGNING_KEY }}
        run: |
          echo $APP_RELEASE_SIGNING_KEY | base64 --decode > app/pusher-notif-release-key.jks

      - name: Get Firebase App Distribution Key
        env:
          CERTIFICATE_BASE64: ${{ secrets.FIREBASE_APP_DISTRIBUTION_KEY }}
        run: |
          echo $FIREBASE_APP_DISTRIBUTION_KEY | base64 --decode > app/main-firebase-app-distribution-admin-key.json

      - name: Assemble Signed Release Apk
        run: ./gradlew assembleRelease

      - name: Upload To Firebase App Distribution
        run: ./gradlew appDistributionUploadRelease
